// åˆ›å»ºBç«™æ’­æ”¾å™¨æŒ‰é’®
const bilibiliBtn = document.createElement('div');
bilibiliBtn.id = 'bilibili-player-btn';
bilibiliBtn.innerHTML = 'ğŸ¬';
bilibiliBtn.style.cssText = `
    position: fixed;
    bottom: 150px;
    right: 20px;
    width: 60px;
    height: 60px;
    background: linear-gradient(135deg, #00a1d6, #f25d8e);
    border-radius: 50%;
    border: 3px solid white;
    color: white;
    font-size: 30px;
    cursor: pointer;
    z-index: 10000;
    display: flex;
    align-items: center;
    justify-content: center;
    box-shadow: 0 6px 20px rgba(0,0,0,0.5);
    transition: all 0.3s ease;
    user-select: none;
`;

// æ·»åŠ æ‚¬åœæ•ˆæœ
bilibiliBtn.addEventListener('mouseenter', () => {
    bilibiliBtn.style.transform = 'scale(1.1)';
    bilibiliBtn.style.boxShadow = '0 8px 25px rgba(0,0,0,0.6)';
});

bilibiliBtn.addEventListener('mouseleave', () => {
    bilibiliBtn.style.transform = 'scale(1)';
    bilibiliBtn.style.boxShadow = '0 6px 20px rgba(0,0,0,0.5)';
});

// è§£æBç«™è§†é¢‘IDçš„æ”¹è¿›å‡½æ•°
function extractBilibiliVideoId(input) {
    // å¤„ç†BVå·
    let bvid = input.match(/BV[a-zA-Z0-9]{10}/i);
    if (bvid) return { type: 'bvid', id: bvid[0] };
    
    // å¤„ç†avå·
    let avid = input.match(/(?:av|AV)(\d+)/i);
    if (avid) return { type: 'avid', id: avid[1] };
    
    // å¤„ç†çŸ­é“¾æ¥
    if (input.includes('b23.tv')) {
        return { type: 'short', url: input };
    }
    
    // å¤„ç†å®Œæ•´çš„URL
    try {
        const url = new URL(input);
        const params = new URLSearchParams(url.search);
        
        if (params.has('bvid')) {
            return { type: 'bvid', id: params.get('bvid') };
        }
        if (params.has('avid')) {
            return { type: 'avid', id: params.get('avid') };
        }
        
        // ä»è·¯å¾„ä¸­æå–
        const pathMatch = url.pathname.match(/\/(BV[a-zA-Z0-9]{10})/i);
        if (pathMatch) return { type: 'bvid', id: pathMatch[1] };
    } catch (e) {
        // å¦‚æœä¸æ˜¯æœ‰æ•ˆçš„URLï¼Œå°è¯•ç›´æ¥ä½¿ç”¨è¾“å…¥
        if (/^BV[a-zA-Z0-9]{10}$/i.test(input)) {
            return { type: 'bvid', id: input };
        }
        if (/^av\d+$/i.test(input)) {
            return { type: 'avid', id: input.replace(/^av/i, '') };
        }
    }
    
    return null;
}

// ä»localStorageè·å–ä¿å­˜çš„çª—å£è®¾ç½®
function getWindowSettings() {
    const saved = localStorage.getItem('bilibili-player-settings');
    if (saved) {
        return JSON.parse(saved);
    }
    return {
        width: 400,
        height: 300,
        left: window.innerWidth - 450,
        top: 100,
        alwaysOnTop: true,
        remember: true
    };
}

// ä¿å­˜çª—å£è®¾ç½®åˆ°localStorage
function saveWindowSettings(settings) {
    localStorage.setItem('bilibili-player-settings', JSON.stringify(settings));
}

// åˆ›å»ºæ ·å¼
const style = document.createElement('style');
style.textContent = `
    #bilibili-prompt {
        position: fixed;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        background: white;
        padding: 25px;
        border-radius: 12px;
        box-shadow: 0 10px 40px rgba(0,0,0,0.3);
        z-index: 100001;
        min-width: 350px;
        max-width: 450px;
    }
    
    #bilibili-prompt h3 {
        margin: 0 0 15px 0;
        color: #333;
        font-family: Arial, sans-serif;
        font-size: 18px;
        display: flex;
        align-items: center;
        gap: 8px;
    }
    
    .input-group {
        margin-bottom: 15px;
    }
    
    .input-group label {
        display: block;
        margin-bottom: 5px;
        color: #555;
        font-size: 14px;
        font-weight: bold;
    }
    
    .input-row {
        display: flex;
        gap: 10px;
    }
    
    .input-row .input-group {
        flex: 1;
    }
    
    #bilibili-input {
        width: 100%;
        padding: 12px;
        border: 2px solid #ddd;
        border-radius: 6px;
        font-size: 14px;
        box-sizing: border-box;
        transition: border-color 0.3s;
    }
    
    #bilibili-input:focus {
        border-color: #00a1d6;
        outline: none;
    }
    
    .size-input {
        width: 100%;
        padding: 10px;
        border: 2px solid #ddd;
        border-radius: 6px;
        font-size: 14px;
        box-sizing: border-box;
        transition: border-color 0.3s;
    }
    
    .size-input:focus {
        border-color: #00a1d6;
        outline: none;
    }
    
    #bilibili-buttons {
        display: flex;
        gap: 10px;
        justify-content: space-between;
        margin-top: 20px;
    }
    
    .bilibili-btn {
        padding: 10px 20px;
        border: none;
        border-radius: 6px;
        cursor: pointer;
        font-weight: bold;
        transition: all 0.3s;
        flex: 1;
    }
    
    #bilibili-confirm {
        background: linear-gradient(135deg, #00a1d6, #f25d8e);
        color: white;
    }
    
    #bilibili-cancel {
        background: #f0f0f0;
        color: #666;
    }
    
    .bilibili-btn:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(0,0,0,0.2);
    }
    
    #bilibili-overlay {
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: rgba(0,0,0,0.5);
        z-index: 100000;
        backdrop-filter: blur(3px);
    }
    
    #bilibili-examples {
        font-size: 12px;
        color: #666;
        margin-top: 10px;
        line-height: 1.4;
        background: #f9f9f9;
        padding: 10px;
        border-radius: 6px;
        border-left: 3px solid #00a1d6;
    }
    
    .checkbox-group {
        display: flex;
        align-items: center;
        gap: 8px;
        margin-top: 10px;
    }
    
    .checkbox-group input[type="checkbox"] {
        width: 16px;
        height: 16px;
    }
    
    .checkbox-group label {
        margin: 0;
        font-size: 14px;
        color: #555;
    }
    
    .preset-buttons {
        display: grid;
        grid-template-columns: repeat(4, 1fr);
        gap: 8px;
        margin-top: 5px;
    }
    
    .preset-btn {
        padding: 8px 4px;
        border: 1px solid #ddd;
        background: white;
        border-radius: 4px;
        font-size: 12px;
        cursor: pointer;
        transition: all 0.2s;
        white-space: nowrap;
        text-align: center;
    }
    
    .preset-btn:hover {
        background: #f0f0f0;
    }
    
    .preset-btn.active {
        background: #00a1d6;
        color: white;
        border-color: #00a1d6;
    }
    
    .position-presets {
        display: grid;
        grid-template-columns: repeat(4, 1fr);
        gap: 8px;
        margin-top: 5px;
    }
    
    .position-btn {
        padding: 8px 4px;
        border: 1px solid #ddd;
        background: white;
        border-radius: 4px;
        font-size: 12px;
        cursor: pointer;
        transition: all 0.2s;
        white-space: nowrap;
        text-align: center;
    }
    
    .position-btn:hover {
        background: #f0f0f0;
    }
    
    .position-btn.active {
        background: #f25d8e;
        color: white;
        border-color: #f25d8e;
    }
    
    .icon {
        font-size: 16px;
    }
    
    .dimension-display {
        font-size: 11px;
        color: #888;
        margin-top: 2px;
    }
    
    /* ç½®é¡¶æ’­æ”¾å™¨çª—å£æ ·å¼ */
    #bilibili-player-window {
        position: fixed;
        background: white;
        border-radius: 12px;
        box-shadow: 0 10px 40px rgba(0,0,0,0.3);
        z-index: 99999;
        overflow: hidden;
        resize: both;
        min-width: 200px;
        min-height: 150px;
        border: 2px solid #00a1d6;
        display: none;
    }
    
    #bilibili-player-window.always-on-top {
        z-index: 100000 !important;
        border-color: #f25d8e;
    }
    
    #bilibili-player-header {
        background: linear-gradient(135deg, #00a1d6, #f25d8e);
        color: white;
        padding: 12px 15px;
        cursor: move;
        display: flex;
        justify-content: space-between;
        align-items: center;
        user-select: none;
    }
    
    #bilibili-player-title {
        font-weight: bold;
        font-size: 14px;
        display: flex;
        align-items: center;
        gap: 8px;
    }
    
    #bilibili-player-controls {
        display: flex;
        gap: 10px;
    }
    
    .player-control-btn {
        background: rgba(255,255,255,0.2);
        border: none;
        color: white;
        width: 24px;
        height: 24px;
        border-radius: 4px;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 14px;
        transition: all 0.2s;
    }
    
    .player-control-btn:hover {
        background: rgba(255,255,255,0.3);
        transform: scale(1.1);
    }
    
    #bilibili-player-content {
        width: 100%;
        height: calc(100% - 48px);
        background: #000;
    }
    
    #bilibili-player-iframe {
        width: 100%;
        height: 100%;
        border: none;
        background: black;
    }
    
    .window-resize-handle {
        position: absolute;
        background: transparent;
        z-index: 10;
    }
    
    .resize-n { top: 0; left: 10px; right: 10px; height: 5px; cursor: n-resize; }
    .resize-e { top: 10px; right: 0; width: 5px; bottom: 10px; cursor: e-resize; }
    .resize-s { bottom: 0; left: 10px; right: 10px; height: 5px; cursor: s-resize; }
    .resize-w { top: 10px; left: 0; width: 5px; bottom: 10px; cursor: w-resize; }
    .resize-ne { top: 0; right: 0; width: 10px; height: 10px; cursor: ne-resize; }
    .resize-nw { top: 0; left: 0; width: 10px; height: 10px; cursor: nw-resize; }
    .resize-se { bottom: 0; right: 0; width: 10px; height: 10px; cursor: se-resize; }
    .resize-sw { bottom: 0; left: 0; width: 10px; height: 10px; cursor: sw-resize; }
    
    .player-control-btn.active {
        background: rgba(255,255,255,0.4);
        box-shadow: inset 0 0 5px rgba(0,0,0,0.3);
    }
    
    #bilibili-player-btn.minimized {
        bottom: 20px;
        right: 20px;
        width: 50px;
        height: 50px;
        font-size: 24px;
    }
`;

document.head.appendChild(style);

// åˆ›å»ºç½®é¡¶æ’­æ”¾å™¨çª—å£
const playerWindow = document.createElement('div');
playerWindow.id = 'bilibili-player-window';

playerWindow.innerHTML = `
    <div id="bilibili-player-header">
        <div id="bilibili-player-title">
            <span>ğŸ¬ Bç«™æ’­æ”¾å™¨</span>
        </div>
        <div id="bilibili-player-controls">
            <button class="player-control-btn" id="player-minimize" title="æœ€å°åŒ–">â–</button>
            <button class="player-control-btn" id="player-always-on-top" title="ç½®é¡¶">ğŸ“Œ</button>
            <button class="player-control-btn" id="player-close" title="å…³é—­">âœ•</button>
        </div>
    </div>
    <div id="bilibili-player-content">
        <iframe id="bilibili-player-iframe" allowfullscreen></iframe>
    </div>
    <div class="window-resize-handle resize-n"></div>
    <div class="window-resize-handle resize-e"></div>
    <div class="window-resize-handle resize-s"></div>
    <div class="window-resize-handle resize-w"></div>
    <div class="window-resize-handle resize-ne"></div>
    <div class="window-resize-handle resize-nw"></div>
    <div class="window-resize-handle resize-se"></div>
    <div class="window-resize-handle resize-sw"></div>
`;

document.body.appendChild(playerWindow);

// æ’­æ”¾å™¨çª—å£çŠ¶æ€
let playerState = {
    isDragging: false,
    isResizing: false,
    resizeDirection: '',
    startX: 0,
    startY: 0,
    startWidth: 0,
    startHeight: 0,
    startLeft: 0,
    startTop: 0,
    alwaysOnTop: true,
    minimized: false
};

// åˆå§‹åŒ–æ’­æ”¾å™¨çª—å£
function initPlayerWindow() {
    const header = document.getElementById('bilibili-player-header');
    const minimizeBtn = document.getElementById('player-minimize');
    const alwaysOnTopBtn = document.getElementById('player-always-on-top');
    const closeBtn = document.getElementById('player-close');
    const resizeHandles = document.querySelectorAll('.window-resize-handle');
    
    // ç½®é¡¶åŠŸèƒ½
    alwaysOnTopBtn.addEventListener('click', function() {
        playerState.alwaysOnTop = !playerState.alwaysOnTop;
        if (playerState.alwaysOnTop) {
            playerWindow.classList.add('always-on-top');
            alwaysOnTopBtn.classList.add('active');
            alwaysOnTopBtn.title = 'å–æ¶ˆç½®é¡¶';
        } else {
            playerWindow.classList.remove('always-on-top');
            alwaysOnTopBtn.classList.remove('active');
            alwaysOnTopBtn.title = 'ç½®é¡¶';
        }
    });
    
    // å…³é—­æ’­æ”¾å™¨
    closeBtn.addEventListener('click', function() {
        playerWindow.style.display = 'none';
        // æ¸…é™¤iframeå†…å®¹
        const iframe = document.getElementById('bilibili-player-iframe');
        iframe.src = 'about:blank';
    });
    
    // æœ€å°åŒ–åŠŸèƒ½
    minimizeBtn.addEventListener('click', function() {
        playerState.minimized = !playerState.minimized;
        if (playerState.minimized) {
            // ä¿å­˜å½“å‰å°ºå¯¸å’Œä½ç½®
            playerWindow.dataset.savedWidth = playerWindow.style.width;
            playerWindow.dataset.savedHeight = playerWindow.style.height;
            playerWindow.dataset.savedLeft = playerWindow.style.left;
            playerWindow.dataset.savedTop = playerWindow.style.top;
            
            // æœ€å°åŒ–åˆ°å³ä¸‹è§’
            playerWindow.style.width = '60px';
            playerWindow.style.height = '60px';
            playerWindow.style.left = 'calc(100% - 80px)';
            playerWindow.style.top = '20px';
            playerWindow.style.resize = 'none';
            
            // éšè—å†…å®¹
            document.getElementById('bilibili-player-content').style.display = 'none';
            document.getElementById('bilibili-player-header').style.padding = '0';
            document.getElementById('bilibili-player-title').style.display = 'none';
            
            minimizeBtn.innerHTML = 'â•';
            minimizeBtn.title = 'æ¢å¤';
        } else {
            // æ¢å¤ä¹‹å‰çš„çŠ¶æ€
            playerWindow.style.width = playerWindow.dataset.savedWidth;
            playerWindow.style.height = playerWindow.dataset.savedHeight;
            playerWindow.style.left = playerWindow.dataset.savedLeft;
            playerWindow.style.top = playerWindow.dataset.savedTop;
            playerWindow.style.resize = 'both';
            
            // æ˜¾ç¤ºå†…å®¹
            document.getElementById('bilibili-player-content').style.display = 'block';
            document.getElementById('bilibili-player-header').style.padding = '12px 15px';
            document.getElementById('bilibili-player-title').style.display = 'flex';
            
            minimizeBtn.innerHTML = 'â–';
            minimizeBtn.title = 'æœ€å°åŒ–';
        }
    });
    
    // æ‹–åŠ¨åŠŸèƒ½
    header.addEventListener('mousedown', startDrag);
    
    // è°ƒæ•´å¤§å°åŠŸèƒ½
    resizeHandles.forEach(handle => {
        handle.addEventListener('mousedown', startResize);
    });
    
    // é¼ æ ‡ç§»åŠ¨äº‹ä»¶
    document.addEventListener('mousemove', function(e) {
        if (playerState.isDragging) {
            const dx = e.clientX - playerState.startX;
            const dy = e.clientY - playerState.startY;
            
            playerWindow.style.left = `${playerState.startLeft + dx}px`;
            playerWindow.style.top = `${playerState.startTop + dy}px`;
        }
        
        if (playerState.isResizing) {
            const dx = e.clientX - playerState.startX;
            const dy = e.clientY - playerState.startY;
            
            let newWidth = playerState.startWidth;
            let newHeight = playerState.startHeight;
            let newLeft = playerState.startLeft;
            let newTop = playerState.startTop;
            
            switch(playerState.resizeDirection) {
                case 'n':
                    newHeight = Math.max(150, playerState.startHeight - dy);
                    newTop = playerState.startTop + (playerState.startHeight - newHeight);
                    break;
                case 's':
                    newHeight = Math.max(150, playerState.startHeight + dy);
                    break;
                case 'e':
                    newWidth = Math.max(200, playerState.startWidth + dx);
                    break;
                case 'w':
                    newWidth = Math.max(200, playerState.startWidth - dx);
                    newLeft = playerState.startLeft + (playerState.startWidth - newWidth);
                    break;
                case 'ne':
                    newHeight = Math.max(150, playerState.startHeight - dy);
                    newWidth = Math.max(200, playerState.startWidth + dx);
                    newTop = playerState.startTop + (playerState.startHeight - newHeight);
                    break;
                case 'nw':
                    newHeight = Math.max(150, playerState.startHeight - dy);
                    newWidth = Math.max(200, playerState.startWidth - dx);
                    newTop = playerState.startTop + (playerState.startHeight - newHeight);
                    newLeft = playerState.startLeft + (playerState.startWidth - newWidth);
                    break;
                case 'se':
                    newHeight = Math.max(150, playerState.startHeight + dy);
                    newWidth = Math.max(200, playerState.startWidth + dx);
                    break;
                case 'sw':
                    newHeight = Math.max(150, playerState.startHeight + dy);
                    newWidth = Math.max(200, playerState.startWidth - dx);
                    newLeft = playerState.startLeft + (playerState.startWidth - newWidth);
                    break;
            }
            
            playerWindow.style.width = `${newWidth}px`;
            playerWindow.style.height = `${newHeight}px`;
            playerWindow.style.left = `${newLeft}px`;
            playerWindow.style.top = `${newTop}px`;
        }
    });
    
    // é¼ æ ‡æ¾å¼€äº‹ä»¶
    document.addEventListener('mouseup', function() {
        playerState.isDragging = false;
        playerState.isResizing = false;
    });
    
    // åˆå§‹åŒ–ç½®é¡¶æŒ‰é’®çŠ¶æ€
    alwaysOnTopBtn.classList.add('active');
}

// å¼€å§‹æ‹–åŠ¨
function startDrag(e) {
    if (e.target.closest('.player-control-btn')) return;
    
    playerState.isDragging = true;
    playerState.startX = e.clientX;
    playerState.startY = e.clientY;
    playerState.startLeft = parseInt(playerWindow.style.left) || 0;
    playerState.startTop = parseInt(playerWindow.style.top) || 0;
    
    // ç¡®ä¿çª—å£åœ¨æœ€å‰é¢
    playerWindow.style.zIndex = playerState.alwaysOnTop ? '100000' : '99999';
}

// å¼€å§‹è°ƒæ•´å¤§å°
function startResize(e) {
    e.stopPropagation();
    playerState.isResizing = true;
    playerState.startX = e.clientX;
    playerState.startY = e.clientY;
    playerState.startWidth = playerWindow.offsetWidth;
    playerState.startHeight = playerWindow.offsetHeight;
    playerState.startLeft = parseInt(playerWindow.style.left) || 0;
    playerState.startTop = parseInt(playerWindow.style.top) || 0;
    playerState.resizeDirection = e.target.className.split(' ')[1].split('-')[1];
}

// åˆå§‹åŒ–æ’­æ”¾å™¨çª—å£
initPlayerWindow();

// ç‚¹å‡»äº‹ä»¶å¤„ç†
bilibiliBtn.onclick = function() {
    // è·å–ä¿å­˜çš„è®¾ç½®
    const savedSettings = getWindowSettings();
    
    // åˆ›å»ºé®ç½©å±‚
    const overlay = document.createElement('div');
    overlay.id = 'bilibili-overlay';
    
    // åˆ›å»ºè¾“å…¥æ¡†
    const promptDiv = document.createElement('div');
    promptDiv.id = 'bilibili-prompt';
    promptDiv.innerHTML = `
        <h3><span class="icon">ğŸ¬</span> Bç«™è§†é¢‘æ’­æ”¾å™¨</h3>
        
        <div class="input-group">
            <label for="bilibili-input">è§†é¢‘é“¾æ¥/BVå·:</label>
            <input type="text" id="bilibili-input" placeholder="https://www.bilibili.com/video/BV1GJ411x7h7/" autofocus>
        </div>
        
        <div class="input-row">
            <div class="input-group">
                <label for="bilibili-width">å®½åº¦ (px):</label>
                <input type="number" id="bilibili-width" class="size-input" value="${savedSettings.width}" min="200" max="1000" step="10">
            </div>
            <div class="input-group">
                <label for="bilibili-height">é«˜åº¦ (px):</label>
                <input type="number" id="bilibili-height" class="size-input" value="${savedSettings.height}" min="150" max="800" step="10">
            </div>
        </div>
        
        <div class="input-group">
            <label>é¢„è®¾å°ºå¯¸:</label>
            <div class="preset-buttons">
                <button class="preset-btn" data-width="200" data-height="150">
                    å¾®å‹
                    <div class="dimension-display">200Ã—150</div>
                </button>
                <button class="preset-btn" data-width="400" data-height="300">
                    å°çª—
                    <div class="dimension-display">400Ã—300</div>
                </button>
                <button class="preset-btn" data-width="600" data-height="450">
                    ä¸­çª—
                    <div class="dimension-display">600Ã—450</div>
                </button>
                <button class="preset-btn" data-width="800" data-height="600">
                    å¤§çª—
                    <div class="dimension-display">800Ã—600</div>
                </button>
            </div>
        </div>
        
        <div class="input-row">
            <div class="input-group">
                <label for="bilibili-left">å·¦è¾¹è· (px):</label>
                <input type="number" id="bilibili-left" class="size-input" value="${savedSettings.left || ''}" placeholder="è‡ªåŠ¨" min="0" step="10">
            </div>
            <div class="input-group">
                <label for="bilibili-top">ä¸Šè¾¹è· (px):</label>
                <input type="number" id="bilibili-top" class="size-input" value="${savedSettings.top || ''}" placeholder="è‡ªåŠ¨" min="0" step="10">
            </div>
        </div>
        
        <div class="input-group">
            <label>é¢„è®¾ä½ç½®:</label>
            <div class="position-presets">
                <button class="position-btn" data-position="top-right">å³ä¸Šè§’</button>
                <button class="position-btn" data-position="bottom-right">å³ä¸‹è§’</button>
                <button class="position-btn" data-position="bottom-left">å·¦ä¸‹è§’</button>
                <button class="position-btn" data-position="top-left">å·¦ä¸Šè§’</button>
            </div>
        </div>
        
        <div class="checkbox-group">
            <input type="checkbox" id="bilibili-always-on-top" ${savedSettings.alwaysOnTop ? 'checked' : ''}>
            <label for="bilibili-always-on-top">å§‹ç»ˆç½®é¡¶</label>
        </div>
        
        <div class="checkbox-group">
            <input type="checkbox" id="bilibili-remember" ${savedSettings.remember ? 'checked' : ''}>
            <label for="bilibili-remember">è®°ä½çª—å£è®¾ç½®</label>
        </div>
        
        <div id="bilibili-examples">
            æ”¯æŒæ ¼å¼ï¼š<br>
            â€¢ å®Œæ•´é“¾æ¥: https://www.bilibili.com/video/BV1GJ411x7h7/<br>
            â€¢ BVå·: BV1GJ411x7h7<br>
            â€¢ avå·: av170001<br>
            â€¢ çŸ­é“¾æ¥: https://b23.tv/xxxx
        </div>
        
        <div id="bilibili-buttons">
            <button id="bilibili-cancel" class="bilibili-btn">å–æ¶ˆ</button>
            <button id="bilibili-confirm" class="bilibili-btn">æ‰“å¼€æ’­æ”¾å™¨</button>
        </div>
    `;
    
    // æ·»åŠ åˆ°é¡µé¢
    overlay.appendChild(promptDiv);
    document.body.appendChild(overlay);
    
    // è·å–å…ƒç´ 
    const input = document.getElementById('bilibili-input');
    const widthInput = document.getElementById('bilibili-width');
    const heightInput = document.getElementById('bilibili-height');
    const leftInput = document.getElementById('bilibili-left');
    const topInput = document.getElementById('bilibili-top');
    const alwaysOnTopCheckbox = document.getElementById('bilibili-always-on-top');
    const rememberCheckbox = document.getElementById('bilibili-remember');
    const confirmBtn = document.getElementById('bilibili-confirm');
    const cancelBtn = document.getElementById('bilibili-cancel');
    const presetButtons = document.querySelectorAll('.preset-btn');
    const positionButtons = document.querySelectorAll('.position-btn');
    
    // é¢„è®¾æŒ‰é’®ç‚¹å‡»äº‹ä»¶
    presetButtons.forEach(btn => {
        btn.addEventListener('click', function() {
            // ç§»é™¤æ‰€æœ‰activeç±»
            presetButtons.forEach(b => b.classList.remove('active'));
            // æ·»åŠ activeç±»åˆ°å½“å‰æŒ‰é’®
            this.classList.add('active');
            
            // è®¾ç½®å®½åº¦å’Œé«˜åº¦
            widthInput.value = this.dataset.width;
            heightInput.value = this.dataset.height;
        });
    });
    
    // ä½ç½®é¢„è®¾æŒ‰é’®ç‚¹å‡»äº‹ä»¶
    positionButtons.forEach(btn => {
        btn.addEventListener('click', function() {
            // ç§»é™¤æ‰€æœ‰activeç±»
            positionButtons.forEach(b => b.classList.remove('active'));
            // æ·»åŠ activeç±»åˆ°å½“å‰æŒ‰é’®
            this.classList.add('active');
            
            // è·å–å½“å‰çª—å£å°ºå¯¸
            const width = parseInt(widthInput.value) || 400;
            const height = parseInt(heightInput.value) || 300;
            
            // æ ¹æ®é€‰æ‹©çš„ä½ç½®è®¡ç®—åæ ‡
            switch(this.dataset.position) {
                case 'top-right':
                    leftInput.value = window.innerWidth - width - 20;
                    topInput.value = 20;
                    break;
                case 'bottom-right':
                    leftInput.value = window.innerWidth - width - 20;
                    topInput.value = window.innerHeight - height - 20;
                    break;
                case 'bottom-left':
                    leftInput.value = 20;
                    topInput.value = window.innerHeight - height - 20;
                    break;
                case 'top-left':
                    leftInput.value = 20;
                    topInput.value = 20;
                    break;
            }
        });
    });
    
    // è‡ªåŠ¨é€‰æ‹©å½“å‰å°ºå¯¸å¯¹åº”çš„é¢„è®¾æŒ‰é’®
    function selectPresetButton() {
        const width = parseInt(widthInput.value) || 400;
        const height = parseInt(heightInput.value) || 300;
        
        presetButtons.forEach(b => {
            if (parseInt(b.dataset.width) === width && parseInt(b.dataset.height) === height) {
                b.classList.add('active');
            } else {
                b.classList.remove('active');
            }
        });
    }
    
    // ç›‘å¬å°ºå¯¸è¾“å…¥å˜åŒ–
    widthInput.addEventListener('input', selectPresetButton);
    heightInput.addEventListener('input', selectPresetButton);
    
    // åˆå§‹é€‰æ‹©é¢„è®¾æŒ‰é’®
    selectPresetButton();
    
    // ç¡®è®¤æŒ‰é’®ç‚¹å‡»
    confirmBtn.onclick = function() {
        const url = input.value.trim();
        if (url) {
            const videoInfo = extractBilibiliVideoId(url);
            
            if (videoInfo) {
                let playerUrl;
                
                if (videoInfo.type === 'bvid') {
                    playerUrl = `https://player.bilibili.com/player.html?bvid=${videoInfo.id}&autoplay=1&high_quality=1&danmaku=0`;
                } else if (videoInfo.type === 'avid') {
                    playerUrl = `https://player.bilibili.com/player.html?aid=${videoInfo.id}&autoplay=1&high_quality=1&danmaku=0`;
                } else {
                    // çŸ­é“¾æ¥ç›´æ¥æ‰“å¼€åŸé¡µé¢
                    window.open(videoInfo.url, '_blank');
                    removePrompt();
                    return;
                }
                
                // è·å–çª—å£è®¾ç½®
                const width = parseInt(widthInput.value) || 400;
                const height = parseInt(heightInput.value) || 300;
                let left = leftInput.value ? parseInt(leftInput.value) : null;
                let top = topInput.value ? parseInt(topInput.value) : null;
                const alwaysOnTop = alwaysOnTopCheckbox.checked;
                const remember = rememberCheckbox.checked;
                
                // å¦‚æœæ²¡æœ‰è®¾ç½®ä½ç½®ï¼Œåˆ™æ”¾åœ¨å³ä¸‹è§’
                if (left === null || top === null) {
                    left = window.innerWidth - width - 20;
                    top = window.innerHeight - height - 20;
                }
                
                // é™åˆ¶çª—å£åœ¨å±å¹•èŒƒå›´å†…
                left = Math.max(0, Math.min(left, window.innerWidth - width));
                top = Math.max(0, Math.min(top, window.innerHeight - height));
                
                // è®¾ç½®æ’­æ”¾å™¨çª—å£
                playerWindow.style.width = `${width}px`;
                playerWindow.style.height = `${height}px`;
                playerWindow.style.left = `${left}px`;
                playerWindow.style.top = `${top}px`;
                playerWindow.style.display = 'block';
                
                // è®¾ç½®ç½®é¡¶çŠ¶æ€
                playerState.alwaysOnTop = alwaysOnTop;
                if (alwaysOnTop) {
                    playerWindow.classList.add('always-on-top');
                    document.getElementById('player-always-on-top').classList.add('active');
                } else {
                    playerWindow.classList.remove('always-on-top');
                    document.getElementById('player-always-on-top').classList.remove('active');
                }
                
                // åŠ è½½è§†é¢‘
                const iframe = document.getElementById('bilibili-player-iframe');
                iframe.src = playerUrl;
                
                // æ›´æ–°æ ‡é¢˜
                const titleElement = document.getElementById('bilibili-player-title');
                titleElement.innerHTML = `<span>ğŸ¬ ${videoInfo.id || 'Bç«™æ’­æ”¾å™¨'}</span>`;
                
                // ä¿å­˜è®¾ç½®
                if (remember) {
                    saveWindowSettings({
                        width,
                        height,
                        left,
                        top,
                        alwaysOnTop,
                        remember
                    });
                } else {
                    // æ¸…é™¤ä¿å­˜çš„è®¾ç½®
                    localStorage.removeItem('bilibili-player-settings');
                }
            } else {
                alert('æ— æ³•è¯†åˆ«çš„Bç«™è§†é¢‘é“¾æ¥ï¼è¯·æ£€æŸ¥æ ¼å¼æ˜¯å¦æ­£ç¡®ã€‚');
                input.focus();
                return;
            }
        } else {
            alert('è¯·è¾“å…¥Bç«™è§†é¢‘é“¾æ¥æˆ–BVå·ï¼');
            input.focus();
            return;
        }
        removePrompt();
    };
    
    // å–æ¶ˆæŒ‰é’®ç‚¹å‡»
    cancelBtn.onclick = removePrompt;
    
    // é®ç½©å±‚ç‚¹å‡»å…³é—­
    overlay.onclick = function(e) {
        if (e.target === overlay) {
            removePrompt();
        }
    };
    
    // å›è½¦é”®æ”¯æŒ
    input.addEventListener('keypress', function(e) {
        if (e.key === 'Enter') {
            confirmBtn.click();
        }
    });
    
    // ç§»é™¤æç¤ºæ¡†å‡½æ•°
    function removePrompt() {
        if (document.body.contains(overlay)) {
            document.body.removeChild(overlay);
        }
    }
    
    // è‡ªåŠ¨èšç„¦è¾“å…¥æ¡†
    setTimeout(() => input.focus(), 100);
};

// æ·»åŠ æŒ‰é’®åˆ°é¡µé¢
document.body.appendChild(bilibiliBtn);

// æ·»åŠ æ§åˆ¶å°æç¤º
console.log('ğŸ¬ Bç«™æ’­æ”¾å™¨æŒ‰é’®å·²åŠ è½½æˆåŠŸï¼');
console.log('ğŸ’¡ æ”¯æŒæ ¼å¼: BVå·ã€avå·ã€å®Œæ•´é“¾æ¥ã€çŸ­é“¾æ¥');
console.log('ğŸ“Œ æ”¯æŒç½®é¡¶çª—å£ã€å¯æ‹–æ‹½ã€å¯è°ƒæ•´å¤§å°');
console.log('ğŸ® åœ¨å½“å‰é¡µé¢å†…æµ®åŠ¨æ’­æ”¾ï¼Œä¸ä¼šæ‰“å¼€æ–°çª—å£');